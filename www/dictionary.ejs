<!-- <!DOCTYPE html> -->

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="container.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="line.css">
  <title>Education Data Dictionary</title>

  <script>
    $(document).ready(() => {
      // hide and show scrollbars dynamically
      $("body").css("overflow", "hidden"); // "auto"

      // waiting error messages
      const err = "<%= error %>"
      if (err.length > 0) {
        alert(err)
      }
    });
  </script>

</head>

<body id="main">

  <!------------------- Title ------------------->
  <h1>
    <%= title %>
  </h1>

  <hr class="line1">
  <br>

  <!------------------- Entity Class Path ------------------->
  <div id="nav-path" class="nav-path">
    <% for (const path of navPathCol) { %>
      <% for (const [i, seg] of path.entries()) { %>
        <span class="nav" onclick="
        $('#search-entity').val('<%= seg %>');
        $('#search-form').submit();">
          <%= seg %>
        </span>
        <% if (i < path.length-1) { %> <span> / </span>
          <% } %>
            <% } %>
              <br>
              <% } %>
  </div>

  <!------------------- Level 1 Field ------------------->
  <div id="nav-field">
    <span class="nav" onclick="scrollToTop('Entity')">Entity</span>&ensp;
    <span class="nav" onclick="scrollToTop('Definition')">Definition</span>&ensp;
    <span class="nav" onclick="scrollToTop('SIF')">SIF</span>&ensp;
    <span class="nav" onclick="scrollToTop('OtherStandards')">OtherStandards</span>&ensp;
    <span class="nav" onclick="scrollToTop('LegalDefinitions')">LegalDefinitions</span>&ensp;
    <span class="nav" onclick="scrollToTop('Collections')">Collections</span>&ensp;
    <span class="nav" onclick="scrollToTop('Metadata')">Metadata</span>&ensp;
  </div>

  <!----------------------------------------------------->
  <div id="container">

    <div id="left">

      <!-- real submitting is in 'check_search_form' -->
      <form id="search-form" action="/" method="post" onsubmit="check_search_form(this); return false">

        <!------------------- Search Input ------------------->
        <div id="search-div">
          <input type="text" id="search-entity" name="entity" placeholder="Entity or Identifier"
            value="<%= search_value %>" style="padding: 5px 0px 5px 10px;">
          <input type="submit" value="go" style="padding: 5px 10px 5px 10px; font-size: 14px;">
        </div>

        <!------------------- Entity List ------------------->
        <!-- set selected item into above text input, then submit form -->
        <ul class="entity-list">
          <% for(const entity of entities) { %>
            <li class="link" onclick="
                    $('#search-entity').val('<%= entity %>');
                    $('#search-form').submit();">
              <span>
                <%= entity %>
              </span>
            </li>
            <% } %>
        </ul>

      </form>

      <!------------------- Add Entity ------------------->
      <!-- upload file by select box. Different from normal, below do submitting when closing select box -->
      <form id="add-form" action="/add" method="post" enctype="multipart/form-data">

        <input id="new-entity" type="button" value="New Entity" onclick="new_entity()" />

        <input id="fileInput" type="file" style="display:none;" name="entity" accept=".json"
          onchange="$('#add-form').submit()" />

        <input id="load-entity" type="button" value="Load Entity" onclick="$('#fileInput').click();" />

      </form>

    </div>

    <!---------------------------------------------------------------->
    <!---------------------------------------------------------------->
    <!---------------------------------------------------------------->

    <div id="content">

      <!------------------- Entity ------------------->
      <div class="block" id="Entity">

        <span class="category">Entity</span>

        <% if (content !=null) { %>
          <span class="content-whole">
            <%=entity%>
          </span>
          <% } %>

      </div>

      <!------------------- Definition ------------------->
      <div class="block" id="Definition">

        <span class="category">Definition</span>

        <% if (content !=null) { %>
          <span class="content-whole">
            <%- definition %>
          </span>
          <% } %>

      </div>

      <!------------------- SIF ------------------->
      <div class="block" id="SIF">

        <span class="category">SIF</span>

        <% if (content !=null) { %>

          <span class="content-flex" contenteditable="false">

            <% for(const [i, s] of sif.entries()) { %>

              <div class="cat-val">
                <span class="sub-cat">XPath:</span>
                <span class="sub-val">
                  <% if ('XPath' in s && s.XPath.length> 0) { %>
                    <% for(const [i, xpath] of s.XPath.entries()) { %>
                      <%- xpath %>
                        <br>
                        <% } %>
                          <% } %>
                </span>
                <button type="button" class="edit">edit</button>
              </div>

              <div class="cat-val">
                <span class="sub-cat">Definition:</span>
                <span class="sub-val">
                  <%= s.Definition %>
                </span>
              </div>

              <div class="cat-val">
                <span class="sub-cat">Commentary:</span>
                <span class="sub-val">
                  <%= s.Commentary %>
                </span>
              </div>

              <div class="cat-val">
                <span class="sub-cat">Datestamp:</span>
                <span class="sub-val">
                  <%= s.Datestamp %>
                </span>
              </div>

              <% if ( i < sif.length - 1 ) { %>
                <hr class="line2">
                <% } %>

                  <% } %>

          </span>

          <% } %>

      </div>

      <!------------------- OtherStandards ------------------->
      <div class="block" id="OtherStandards">

        <span class="category">OtherStandards</span>

        <% if (content !=null) { %>

          <span class="content-flex">

            <% for(const [i, os] of otherStandards.entries()) { %>

              <% if ('Standard' in os && os.Standard.length> 0) { %>
                <div class="cat-val">
                  <span class="sub-cat">Standard:</span>
                  <span class="sub-val">
                    <%= os.Standard %>
                  </span>
                </div>
                <% } %>

                  <% if ('Link' in os && os.Link.length> 0) { %>
                    <div class="cat-val">
                      <span class="sub-cat">Link:</span>
                      <span class="sub-val">
                        <% for(const link of os.Link) { %>
                          <%- link %>
                            <% } %>
                      </span>
                    </div>
                    <% } %>

                      <% if ('Path' in os && os.Path.length> 0) { %>
                        <div class="cat-val">
                          <span class="sub-cat">Path:</span>
                          <span class="sub-val">
                            <% for(const path of os.Path) { %>
                              <%= path %>
                                <br>
                                <% } %>
                          </span>
                        </div>
                        <% } %>

                          <% if ('Definition' in os && os.Definition.length> 0) { %>
                            <div class="cat-val">
                              <span class="sub-cat">Definition:</span>
                              <span class="sub-val">
                                <%= os.Definition %>
                              </span>
                            </div>
                            <% } %>

                              <% if ('Commentary' in os && os.Commentary.length> 0) { %>
                                <div class="cat-val">
                                  <span class="sub-cat">Commentary:</span>
                                  <span class="sub-val">
                                    <%- os.Commentary %>
                                  </span>
                                </div>
                                <% } %>

                                  <% if ('Datestamp' in os && os.Datestamp.length> 0) { %>
                                    <div class="cat-val">
                                      <span class="sub-cat">Datestamp:</span>
                                      <span class="sub-val">
                                        <%= os.Datestamp %>
                                      </span>
                                    </div>
                                    <% } %>

                                      <% if ( i < otherStandards.length - 1 ) { %>
                                        <hr class="line2">
                                        <% } %>

                                          <% } %>

          </span>

          <% } %>

      </div>

      <!------------------- LegalDefinitions ------------------->
      <div class="block" id="LegalDefinitions">

        <span class="category">LegalDefinitions</span>

        <% if (content !=null) { %>

          <span class="content-flex">

            <% for(const [i, ld] of legalDefinitions.entries()) { %>

              <% if ('LegislationName'in ld && ld.LegislationName.length>0) { %>
                <div class="cat-val">
                  <span class="sub-cat">LegislationName:</span>
                  <span class="sub-val">
                    <%= ld.LegislationName %>
                  </span>
                </div>
                <% } %>

                  <% if ('Citation' in ld && ld.Citation.length>0) { %>
                    <div class="cat-val">
                      <span class="sub-cat">Citation:</span>
                      <span class="sub-val">
                        <%= ld.Citation %>
                      </span>
                    </div>
                    <% } %>

                      <% if ('Link' in ld && ld.Link.length>0) { %>
                        <div class="cat-val">
                          <span class="sub-cat">Link:</span>
                          <span class="sub-val">
                            <%- ld.Link %>
                          </span>
                        </div>
                        <% } %>

                          <% if ('Definition' in ld && ld.Definition.length>0) { %>
                            <div class="cat-val">
                              <span class="sub-cat">Definition:</span>
                              <span class="sub-val">
                                <%- ld.Definition %>
                              </span>
                            </div>
                            <% } %>

                              <% if ('Commentary' in ld && ld.Commentary.length>0) { %>
                                <div class="cat-val">
                                  <span class="sub-cat">Commentary:</span>
                                  <span class="sub-val">
                                    <%= ld.Commentary %>
                                  </span>
                                </div>
                                <% } %>

                                  <% if ('Datestamp' in ld && ld.Datestamp.length>0) { %>
                                    <div class="cat-val">
                                      <span class="sub-cat">Datestamp:</span>
                                      <span class="sub-val">
                                        <%= ld.Datestamp %>
                                      </span>
                                    </div>
                                    <% } %>

                                      <% if ( i < legalDefinitions.length - 1 ) { %>
                                        <hr class="line2">
                                        <% } %>

                                          <% } %>

          </span>

          <% } %>

      </div>


      <!------------------- Collections ------------------->
      <div class="block" id="Collections">

        <span class="category">Collections</span>

        <% if (content !=null) { %>

          <span class="content-flex">

            <% for(const [i, col] of collections.entries()) { %>

              <% if ('Name' in col && col.Name.length> 0) { %>
                <div class="cat-val">
                  <span class="sub-cat">Name:</span>
                  <span class="sub-val">
                    <%= col.Name %>
                  </span>
                </div>
                <% } %>

                  <% if ('Description' in col && col.Description.length>0) { %>
                    <div class="cat-val">
                      <span class="sub-cat">Description:</span>
                      <span class="sub-val">
                        <%= col.Description %>
                      </span>
                    </div>
                    <% } %>

                      <% if ('BusinessRules' in col && col.BusinessRules.length>0) { %>
                        <div class="cat-val">
                          <span class="sub-cat">BusinessRules:</span>
                          <span class="sub-val">
                            <% for( let rule of col.BusinessRules) { %>
                              <%= rule %>
                                <br>
                                <% } %>
                          </span>
                        </div>
                        <% } %>

                          <% if ('Standard' in col && col.Standard.length>0) { %>
                            <div class="cat-val">
                              <span class="sub-cat">Standard:</span>
                              <span class="sub-val">
                                <%= col.Standard %>
                              </span>
                            </div>
                            <% } %>

                              <% if ('Elements' in col && col.Elements.length>0) { %>
                                <div class="cat-val">
                                  <span class="sub-cat">Elements:</span>
                                  <span class="sub-val">
                                    <% for (let ele of col.Elements) { %>
                                      <%= ele %>
                                        <br>
                                        <% } %>
                                  </span>
                                </div>
                                <% } %>

                                  <% if ('DefinitionModification' in col && col.DefinitionModification.length>0) {%>
                                    <div class="cat-val">
                                      <span class="sub-cat">DefinitionModification:</span>
                                      <span class="sub-val">
                                        <%= col.DefinitionModification %>
                                      </span>
                                    </div>
                                    <% } %>

                                      <% if ( i < collections.length - 1 ) { %>
                                        <hr class="line2">
                                        <% } %>

                                          <% } %>

          </span>

          <% } %>

      </div> <!-- Collections -->

      <!------------------- Metadata ------------------->
      <div class="block" id="Metadata">

        <span class="category">Metadata</span>

        <% if (content !=null) { %>

          <span class="content-flex">

            <% if (identifier.length>0) { %>
              <div class="cat-val">
                <span class="sub-cat">Identifier:</span>
                <span class="sub-val">
                  <%= identifier %>
                </span>
              </div>
              <% } %>

                <% if (otherNames.length>0) { %>
                  <div class="cat-val">
                    <span class="sub-cat">OtherNames:</span>
                    <span class="sub-val">
                      <% for(const [i, on] of otherNames.entries()) { %>
                        <%= on %>
                          <% if (i < otherNames.length - 1) { %> &nbsp;|&nbsp; <% } } %>
                    </span>
                  </div>
                  <% } %>

                    <% if (type.length>0) { %>
                      <div class="cat-val">
                        <span class="sub-cat">Type:</span>
                        <span class="sub-val">
                          <%= type %>
                        </span>
                      </div>
                      <% } %>

                        <% if (expectedAttributes.length>0) { %>
                          <div class="cat-val">
                            <span class="sub-cat">ExpectedAttributes:</span>
                            <span class="sub-val">
                              <% for(const [i, attr] of expectedAttributes.entries()) { %>
                                <span class="shortarray-link"
                                  onclick="$('#search-entity').val('<%= attr %>'); $('#search-form').submit();">
                                  <%= attr %>
                                </span>
                                <% if ( i < expectedAttributes.length - 1) { %> &nbsp;|&nbsp; <% } %>
                                    <% } %>
                            </span>
                          </div>
                          <% } %>

                            <% if (defParent.length>0) { %>
                              <div class="cat-val">
                                <span class="sub-cat">DefaultParent:</span>
                                <span class="sub-val"
                                  onclick="$('#search-entity').val('<%= defParent %>'); $('#search-form').submit();">
                                  <%= defParent %>
                                </span>
                              </div>
                              <% } %>

                                <% if (superclass.length>0) { %>
                                  <div class="cat-val">
                                    <span class="sub-cat">Superclass:</span>
                                    <span class="sub-val">
                                      <% for(const [i, sc] of superclass.entries()) { %>
                                        <span class="shortarray-link"
                                          onclick="$('#search-entity').val('<%= sc %>'); $('#search-form').submit();">
                                          <%= sc %>
                                        </span>
                                        <% if ( i < superclass.length - 1) { %> &nbsp;|&nbsp; <% } %>
                                            <% } %>
                                    </span>
                                  </div>
                                  <% } %>

                                    <% if (crossrefEntities.length>0) { %>
                                      <div class="cat-val">
                                        <span class="sub-cat">CrossrefEntities:</span>
                                        <span class="sub-val">
                                          <% for(const [i, crf] of crossrefEntities.entries()) { %>
                                            <span class="shortarray-link"
                                              onclick="$('#search-entity').val('<%= crf %>'); $('#search-form').submit();">
                                              <%= crf %>
                                            </span>
                                            <% if (i < crossrefEntities.length - 1) { %> &nbsp;|&nbsp; <% } %>
                                                <% } %>
                                        </span>
                                      </div>
                                      <% } %>

          </span>

          <% } %>

      </div> <!-- Metadata -->

      <!---------------- END Block ---------------->

      <div id="bottom-padding">
      </div>

    </div> <!-- content -->

  </div> <!-- container -->

  <!-------------------------------- END Page -------------------------------->

  <script>

    const scrollToTop = (eleID) => {
      $('#' + eleID)[0].scrollIntoView(true)
      $('#main')[0].scrollTop = 0
    }

    const scrollToBottom = (eleID) => {
      $('#' + eleID)[0].scrollIntoView(false)
      $('#main')[0].scrollTop = 0
    }

    // before real submitting, check background in advance 
    const check_search_form = async (form) => {

      let sv = $('#search-entity').val()

      if (!isNaN(sv)) {
        sv = String(sv).padStart(4, '0')
      }

      let api_list = [
        `http://localhost:3000/api/entity/${sv}`,
        `http://localhost:3000/api/identifier/${sv}`
      ]

      for (let api of api_list) {
        const resp = await fetch(
          api, {
          method: 'GET',
          mode: 'cors',
        }
        )
        const code = await resp.status
        if (code == 200) {
          form.submit()
          return
        }
      }

      alert(`Couldn't find ${sv}`)
    }

    // normal POST action
    const new_entity = async () => {

      let entityName = prompt('Please entre new entity name:', '')
      if (entityName.length == 0) {
        return
      }

      // existing check
      const respChk = await fetch(
        `http://localhost:3000/api/entity/${entityName}`,
        {
          method: 'GET',
          mode: 'cors',
        }
      )
      const codeChk = await respChk.status
      if (codeChk == 200) {
        alert(`[${entityName}] is already existing`)
        return
      }

      // new an empty entity
      const newEntity = {
        Entity: entityName,
        Definition: "",
        SIF: [],
        OtherStandards: [],
        LegalDefinitions: [],
        Collections: [],
        Meta: "",
      }

      const respNew = await fetch(
        `http://localhost:3000/new`,
        {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(newEntity),
        }
      )

      const codeNew = await respNew.status
      if (codeNew == 200) {

        await (async () => {
          await new Promise(resolve => setTimeout(resolve, 200));
          window.location.replace(`http://localhost:3000/?entity=${entityName}`)
        })()

      }
    }

  </script>

</body>

</html>